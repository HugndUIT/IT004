-- Câu 1

CREATE DATABASE QlyThi

USE QlyThi

CREATE TABLE LOP (
	MALOP VARCHAR(5) PRIMARY KEY,
	TENLOP VARCHAR(20),
	SISO INT
)

CREATE TABLE SINHVIEN (
	MSSV VARCHAR(5) PRIMARY KEY,
	HOSV NVARCHAR(20),
	TENSV NVARCHAR(10),
	PHAI NVARCHAR(3),
	MALOP VARCHAR(5) FOREIGN KEY REFERENCES LOP(MALOP)
)

CREATE TABLE MONHOC (
	MAMH VARCHAR(5) PRIMARY KEY,
	TENMON NVARCHAR(30),
	SOTINCHI INT
)

CREATE TABLE KETQUATHI (
	MSSV VARCHAR(5) FOREIGN KEY REFERENCES SINHVIEN(MSSV),
	MAMH VARCHAR(5) FOREIGN KEY REFERENCES MONHOC(MAMH),
	DIEM FLOAT,
	LANTHI INT
	PRIMARY KEY (MSSV, MAMH)
)

-- Câu 2

INSERT INTO LOP VALUES
('L0001', 'DH5TH1', 4),
('L0002', 'DH5TH2', 4),
('L0003', 'DH6TH1', 4)

INSERT INTO SINHVIEN VALUES
('SV001', 'Lê Thị', 'Hoa', 'Nữ', 'L0001'),
('SV002', 'Trần Hồng', 'Tam', 'Nam', 'L0001'),
('SV003', 'Hoàng Văn', 'Bình', 'Nam', 'L0001'),
('SV004', 'Lý Bình', 'Nguyên', 'Nam', 'L0001'),
('SV005', 'Mã', 'Văn', 'Nam', 'L0002')

INSERT INTO MONHOC VALUES
('MH001', 'Toán rời rạc', 5),
('MH002', 'Cơ sở dữ liệu', 4),
('MH003', 'Hệ điều hành', 5)

INSERT INTO KETQUATHI VALUES
('SV001', 'MH001', 4, 1),
('SV002', 'MH002', 6, 1),
('SV001', 'MH002', 7, 2),
('SV003', 'MH001', 3.5, 1),
('SV003', 'MH002', 9, 1),
('SV003', 'MH003', 7, 2)

-- Câu 3

ALTER TABLE KETQUATHI ADD CONSTRAINT Gia_Tri_Diem CHECK (DIEM BETWEEN 0 AND 10)

ALTER TABLE KETQUATHI ADD CONSTRAINT So_Lan_Thi CHECK (LANTHI <= 3)

-- Câu 4

SELECT SV.MSSV, SV.HOSV, SV.TENSV
FROM SINHVIEN SV
WHERE SV.PHAI = N'Nam' 
AND SV.MALOP = 'L0001'

-- Câu 5

GO
CREATE TRIGGER INSERT_SINHVIEN
ON SINHVIEN
AFTER INSERT
AS
BEGIN
	IF EXISTS (SELECT *
		FROM INSERTED I
		WHERE I.MALOP NOT IN (SELECT L.MALOP
			FROM LOP L
		)
	)
	BEGIN
		ROLLBACK TRANSACTION
		PRINT ('Loi')
	END
END

-- Câu 6

SELECT SV.MSSV, SV.HOSV, SV.TENSV, KQ.MAMH, KQ.DIEM
FROM SINHVIEN SV
JOIN KETQUATHI KQ ON SV.MSSV = KQ.MSSV
WHERE KQ.LANTHI = 2

-- Câu 7

SELECT SV.MSSV, SV.HOSV, SV.TENSV
FROM SINHVIEN SV
JOIN KETQUATHI KQ ON SV.MSSV = KQ.MSSV
WHERE KQ.MAMH = 'MH001'
INTERSECT 
SELECT SV.MSSV, SV.HOSV, SV.TENSV
FROM SINHVIEN SV
JOIN KETQUATHI KQ ON SV.MSSV = KQ.MSSV
WHERE KQ.MAMH = 'MH002'

-- Câu 8

WITH DANHSACHSVTHILAN1 AS (
	SELECT SV.MSSV, SV.HOSV, SV.TENSV, KQ.DIEM
	FROM SINHVIEN SV
	JOIN KETQUATHI KQ ON KQ.MSSV = SV.MSSV
	WHERE KQ.LANTHI = 1
)
SELECT TOP 1 WITH TIES DS.MSSV, DS.HOSV, DS.TENSV,  DS.DIEM
FROM DANHSACHSVTHILAN1 DS
ORDER BY DS.DIEM DESC

-- Câu 9

SELECT MH.MAMH, MH.TENMON, COUNT(DISTINCT KQ.MSSV) AS SOLUONGSV
FROM MONHOC MH
LEFT JOIN KETQUATHI KQ ON KQ.MAMH = MH.MAMH
GROUP BY MH.MAMH, MH.TENMON

-- Câu 10

SELECT SV.MSSV, SV.HOSV, SV.TENSV
FROM SINHVIEN SV
JOIN KETQUATHI KQ ON SV.MSSV = KQ.MSSV
GROUP BY SV.MSSV, SV.HOSV, SV.TENSV
HAVING COUNT(DISTINCT KQ.MAMH) = (SELECT COUNT(*)
	FROM MONHOC)