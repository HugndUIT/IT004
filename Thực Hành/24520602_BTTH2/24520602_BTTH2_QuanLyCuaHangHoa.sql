-- 24520602 -- Nguyễn Duy Hưng

-- Tạo các quan hệ và khai báo các khóa chính, khóa ngoại của quan hệ

CREATE DATABASE QlyCuaHangHoa

USE QlyCuaHangHoa

CREATE TABLE NHAVUON (
    MANY CHAR(10) PRIMARY KEY,
    NGDAIDIEN NVARCHAR(50),
    SDT CHAR(10),
    DIACHI NVARCHAR(100)
);

CREATE TABLE SANPHAM (
    MASP CHAR(10) PRIMARY KEY,
    TENSP NVARCHAR(50),
    DVT NVARCHAR(10),
    THELOAI NVARCHAR(20),
    GIANHAP DECIMAL(12,2),
    GIABAN DECIMAL(12,2),
    MANY CHAR(10),
    FOREIGN KEY (MANY) REFERENCES NHAVUON(MANY)
);

CREATE TABLE DONHANG (
    MADH CHAR(10) PRIMARY KEY,
    NGAYBAN DATE,
    TONGTIEN DECIMAL(12,2),
    DATHANHTOAN BIT
);

CREATE TABLE CTDH (
    MADH CHAR(10),
    MASP CHAR(10),
    SOLUONG INT,
    PRIMARY KEY (MADH, MASP),
    FOREIGN KEY (MADH) REFERENCES DONHANG(MADH),
    FOREIGN KEY (MASP) REFERENCES SANPHAM(MASP)
);

CREATE TABLE GIAOHANG (
    MAGH CHAR(10) PRIMARY KEY,
    MADH CHAR(10),
    NGAYGIAO DATE,
    NGGIAO NVARCHAR(50),
    DT_NGGIAO CHAR(10),
    NGNHAN NVARCHAR(50),
    DT_NGNHAN CHAR(10),
    DCHI_NGNHAN NVARCHAR(100),
    PHISHIP DECIMAL(10,2),
    SOTIEN DECIMAL(12,2),
    DAGIAO BIT,
    FOREIGN KEY (MADH) REFERENCES DONHANG(MADH)
);

-- Tạo dữ liệu mẫu

INSERT INTO NHAVUON (MANY, NGDAIDIEN, SDT, DIACHI) VALUES
('NV01', 'Nguyen Thanh An', '0905123456', '12 Tran Phu, Q.5, TP.HCM'),
('NV02', 'Pham Bao Han', '0989234567', '45 Nguyen Van Linh, Da Nang'),
('NV03', 'Le Minh Chau', '0977333444', '89 Truong Chinh, Ha Noi'),
('NV04', 'Tran Thi Hoa', '0911998877', '22 Vo Thi Sau, Vung Tau'),
('NV05', 'Vu Duc Huy', '0938665544', '66 Le Loi, TP.Hue');

INSERT INTO SANPHAM (MASP, TENSP, DVT, THELOAI, GIANHAP, GIABAN, MANY) VALUES
('SP01', N'Hoa Tulip Đỏ', N'bó', N'hoa bó sẵn', 95000, 125000, 'NV01'),
('SP02', N'Hoa Ly Vàng', N'bó', N'hoa bó sẵn', 70000, 95000, 'NV03'),
('SP03', N'Lan Mokara', N'chậu', N'hoa chậu', 280000, 340000, 'NV02'),
('SP04', N'Hoa Hướng Dương', N'cành', N'hoa cắt cành', 25000, 32000, 'NV01'),
('SP05', N'Cây Lưỡi Hổ', N'chậu', N'cây cảnh mini', 60000, 85000, 'NV05'),
('SP06', N'Chậu Xương Rồng Mix', N'chậu', N'chậu hoa cắm sẵn', 80000, 100000, 'NV04'),
('SP07', N'Hoa Cẩm Chướng', N'cành', N'hoa nhập khẩu', 150000, 180000, 'NV04'),
('SP08', N'Bó Hồng Pastel', N'bó', N'hoa bó sẵn', 100000, 130000, 'NV02');

INSERT INTO DONHANG (MADH, NGAYBAN, TONGTIEN, DATHANHTOAN) VALUES
('DH101', '2024-03-12', 260000, 0),
('DH102', '2024-04-15', 340000, 100000),
('DH103', '2024-05-20', 125000, 0),
('DH104', '2024-07-05', 195000, 195000),
('DH105', '2024-08-10', 255000, 0),
('DH106', '2024-09-15', 100000, 50000),
('DH107', '2024-09-25', 320000, 0),
('DH108', '2024-10-01', 85000, 85000);

INSERT INTO CTDH (MADH, MASP, SOLUONG) VALUES
('DH101', 'SP04', 4),
('DH102', 'SP03', 1),
('DH103', 'SP01', 1),
('DH104', 'SP05', 2),
('DH105', 'SP06', 3),
('DH106', 'SP08', 1),
('DH107', 'SP07', 2),
('DH108', 'SP02', 1);

INSERT INTO GIAOHANG (MAGH, MADH, NGAYGIAO, NGGIAO, DT_NGGIAO, NGNHAN, DT_NGNHAN, DCHI_NGNHAN, PHISHIP, SOTIEN, DAGIAO) VALUES
('GH101', 'DH101', '2024-03-13', 'Shipper Minh', '0311002233', 'Tran Thi Bich', '0908111222', '12 Nguyen Trai, Q.1, TP.HCM', 20000, 260000, 1),
('GH102', 'DH102', '2024-04-16', 'Shipper An', '0355667788', 'Le Van Long', '0989123456', '75 Phan Chu Trinh, Da Nang', 25000, 340000, 1),
('GH103', 'DH103', '2024-05-21', 'Shipper Bao', '0344333222', 'Pham Thu Trang', '0939222111', '33 Ly Thuong Kiet, Ha Noi', 15000, 125000, 1),
('GH104', 'DH104', '2024-07-06', 'Shipper Minh', '0311002233', 'Do Thanh Nhan', '0919887766', '89 Nguyen Dinh Chieu, Q.3, TP.HCM', 30000, 195000, 1),
('GH105', 'DH105', '2024-08-11', 'Shipper Khang', '0377665544', 'Hoang Thi Lan', '0944777888', '22 Nguyen Hue, Hue', 20000, 255000, 0),
('GH106', 'DH106', '2024-09-16', 'Shipper An', '0355667788', 'Pham Duc Tai', '0911999333', '101 Phan Dinh Phung, Da Lat', 25000, 100000, 1),
('GH107', 'DH107', '2024-09-26', 'Shipper Bao', '0344333222', 'Nguyen Kim Phuong', '0909333555', '18 Hoang Hoa Tham, Q.10, TP.HCM', 35000, 320000, 0),
('GH108', 'DH108', '2024-10-02', 'Shipper Minh', '0311002233', 'Bui My Hanh', '0945667788', '9 Hai Ba Trung, Ha Noi', 20000, 85000, 1);

-- Đề I

-- 1.a
ALTER TABLE GIAOHANG ADD CONSTRAINT CHECK_GH CHECK (DAGIAO IN (0,1))

-- 1.b
UPDATE DONHANG SET TONGTIEN = TONGTIEN * 0.98 WHERE NGAYBAN > '2023-11-1'

-- 2.a
SELECT MASP, TENSP FROM SANPHAM WHERE THELOAI = N'hoa chậu' AND GIABAN = GIANHAP * 1.1

-- 2.b
SELECT NGGIAO, DT_NGGIAO FROM GIAOHANG JOIN DONHANG ON GIAOHANG.MADH = DONHANG.MADH WHERE DAGIAO = 1 AND GIAOHANG.NGAYGIAO = '2023-10-20' AND DONHANG.NGAYBAN = '2023-10-19'

-- 2.c 
SELECT MASP, TENSP, NHAVUON.MANY FROM SANPHAM LEFT JOIN NHAVUON ON SANPHAM.MANY = NHAVUON.MANY WHERE SANPHAM.THELOAI = N'Hoa nhập khẩu'

-- 2.d
(SELECT DONHANG.MADH FROM DONHANG JOIN CTDH ON DONHANG.MADH = CTDH.MADH JOIN SANPHAM ON CTDH.MASP = SANPHAM.MASP WHERE YEAR(NGAYBAN) = '2023' AND TENSP = N'Hoa Hồng')
INTERSECT
(SELECT DONHANG.MADH FROM DONHANG JOIN CTDH ON DONHANG.MADH = CTDH.MADH JOIN SANPHAM ON CTDH.MASP = SANPHAM.MASP WHERE YEAR(NGAYBAN) = '2023' AND TENSP = N'Hoa Cúc')

-- Đề II

-- 1.a
ALTER TABLE SANPHAM ADD CONSTRAINT CHECK_TL CHECK (THELOAI IN (N'chậu hoa', N'cắm sẵn', N'hoa bó sẵn', N'hoa chậu', N'hoa cắt cành', N'hoa nhập khẩu', N'lá trang trí'))

-- 1.b
UPDATE GIAOHANG SET PHISHIP = PHISHIP * 1.05 WHERE NGAYGIAO = '2023-11-20'

-- 2.a
SELECT MASP,TENSP FROM SANPHAM WHERE DVT = N'bó' AND GIABAN = GIANHAP * 1.4

-- 2.b
SELECT NGNHAN, DT_NGNHAN FROM GIAOHANG JOIN DONHANG ON GIAOHANG.MADH = DONHANG.MADH WHERE NGAYBAN = '2023-10-20' AND NGAYGIAO = '2023-10-21'

-- 2.c
SELECT DONHANG.MADH, TONGTIEN, MAGH FROM DONHANG LEFT JOIN GIAOHANG ON DONHANG.MADH = GIAOHANG.MADH WHERE NGAYBAN = '2023-10-20'

-- 2.d
(SELECT DONHANG.MADH FROM DONHANG JOIN CTDH ON DONHANG.MADH = CTDH.MADH JOIN SANPHAM ON CTDH.MASP = SANPHAM.MASP WHERE YEAR(NGAYBAN) = '2023' AND TENSP = N'Hoa Hồng')
EXCEPT
(SELECT DONHANG.MADH FROM DONHANG JOIN CTDH ON DONHANG.MADH = CTDH.MADH JOIN SANPHAM ON CTDH.MASP = SANPHAM.MASP WHERE YEAR(NGAYBAN) = '2023' AND TENSP = N'Hoa Cúc')