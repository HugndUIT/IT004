-- 24520602 -- Nguyễn Duy Hưng

CREATE DATABASE QlyCanHo

CREATE TABLE KHACHHANG (
	MAKH VARCHAR(5) PRIMARY KEY,
	TENKH NVARCHAR(255),
	NGAYSINH DATETIME,
	DIACHI NVARCHAR(255),
	CMND VARCHAR(12)
)

CREATE TABLE LOAICH (
	MALCH VARCHAR(5) PRIMARY KEY,
	TENLCH NVARCHAR(255),
	NHOMCC NVARCHAR(20)
)

CREATE TABLE CANHO (
	MACH VARCHAR(5) PRIMARY KEY,
	TENCH NVARCHAR(255),
	MALCH VARCHAR(5) REFERENCES LOAICH(MALCH),
	DIENTICH FLOAT,
	VITRI INT,
	SOPHONG INT,
	GIA MONEY
)

CREATE TABLE HINHTHUCTG (
	MAHT VARCHAR(5) PRIMARY KEY,
	TENHT NVARCHAR(255),
	PHANTRAMTT FLOAT,
	LAISUAT FLOAT,
	KYHAN INT,
)

CREATE TABLE TRAGOP (
	MATG VARCHAR(5) PRIMARY KEY,
	MACH VARCHAR(5) REFERENCES CANHO(MACH),
	MAKH VARCHAR(5) REFERENCES KHACHHANG(MAKH),
	MAHT VARCHAR(5) REFERENCES HINHTHUCTG(MAHT),
	NGAYMUA DATETIME,
	SOTIENTT MONEY
)

INSERT INTO KHACHHANG (MAKH, TENKH, NGAYSINH, DIACHI, CMND) VALUES
('KH001', N'Nguyễn Văn An', '1990-05-15', N'123 Lê Lợi, Q1, TP.HCM', '024520602'),
('KH002', N'Trần Thị Bích', '1995-10-20', N'45 Nguyễn Huệ, Q1, TP.HCM', '272345678'),
('KH003', N'Lê Hoàng Nam', '1988-12-05', N'12 Âu Cơ, Tân Bình, TP.HCM', '079345678'),
('KH004', N'Phạm Minh Tuấn', '1992-03-25', N'89 Lý Thường Kiệt, Q10, TP.HCM', '024987654'),
('KH005', N'Hoàng Thùy Linh', '1998-07-14', N'56 Võ Văn Ngân, Thủ Đức, TP.HCM', '024112233');

INSERT INTO LOAICH (MALCH, TENLCH, NHOMCC) VALUES
('LCH01', N'Căn hộ thông thường', N'Bình dân'),
('LCH02', N'Studio', N'Trung cấp'),
('LCH03', N'Shophouse', N'Cao cấp'),
('LCH04', N'Penthouse', N'Cao cấp'),
('LCH05', N'Duplex', N'Cao cấp');

INSERT INTO CANHO (MACH, TENCH, MALCH, DIENTICH, VITRI, SOPHONG, GIA) VALUES
('CH001', N'Block A - 01', 'LCH01', 65.5, 3, 2, 1500000000),
('CH002', N'Block B - Studio', 'LCH02', 45.0, 5, 1, 2200000000),
('CH003', N'Shop House Tầng 1', 'LCH03', 120.0, 1, 0, 8500000000),
('CH004', N'Penthouse View Sông', 'LCH04', 250.0, 20, 4, 15000000000),
('CH005', N'Duplex Thông tầng', 'LCH05', 180.0, 15, 3, 9000000000);

INSERT INTO HINHTHUCTG (MAHT, TENHT, PHANTRAMTT, LAISUAT, KYHAN) VALUES
('HT001', N'Vay ngân hàng 70%', 30.0, 0.8, 120),
('HT002', N'Thanh toán theo tiến độ', 20.0, 0.0, 24),
('HT003', N'Vay ưu đãi lãi suất', 50.0, 0.5, 60),
('HT004', N'Trả góp chủ đầu tư', 40.0, 1.2, 36),
('HT005', N'Vay gói 30 năm', 15.0, 0.9, 360);

INSERT INTO TRAGOP (MATG, MACH, MAKH, MAHT, NGAYMUA, SOTIENTT) VALUES
('TG001', 'CH001', 'KH001', 'HT001', '2023-01-10', 450000000),  
('TG002', 'CH002', 'KH002', 'HT002', '2023-02-15', 440000000), 
('TG003', 'CH003', 'KH003', 'HT003', '2023-03-20', 4250000000), 
('TG004', 'CH004', 'KH004', 'HT004', '2023-04-05', 6000000000), 
('TG005', 'CH005', 'KH005', 'HT005', '2023-05-12', 1350000000); 

-- 1.1
GO
CREATE TRIGGER UPDATE_CANHO
ON CANHO
AFTER UPDATE
AS
BEGIN
	IF UPDATE(DIENTICH)
	BEGIN
		IF (SELECT COUNT(MATG)
			FROM TRAGOP 
			JOIN HINHTHUCTG ON TRAGOP.MAHT = HINHTHUCTG.MAHT
			JOIN INSERTED ON INSERTED.MACH = TRAGOP.MACH
			WHERE INSERTED.DIENTICH > 50 
			AND HINHTHUCTG.KYHAN < 24) > 0
		BEGIN
			ROLLBACK TRANSACTION
			RAISERROR(N'Các căn hộ có diện tích trên 50m2 thì KHÔNG được trả góp với kỳ hạn dưới 24 tháng.', 16, 1) 
		END
	END
END

GO
CREATE TRIGGER UPDATE_HINHTHUCTG
ON HINHTHUCTG
AFTER UPDATE
AS
BEGIN
	IF UPDATE(KYHAN)
	BEGIN
		IF (SELECT COUNT(MATG)
			FROM TRAGOP 
			JOIN CANHO ON TRAGOP.MACH = CANHO.MACH
			JOIN INSERTED ON INSERTED.MAHT = TRAGOP.MAHT
			WHERE CANHO.DIENTICH > 50 
			AND INSERTED.KYHAN < 24) > 0
		BEGIN
			ROLLBACK TRANSACTION
			RAISERROR(N'Các căn hộ có diện tích trên 50m2 thì KHÔNG được trả góp với kỳ hạn dưới 24 tháng.', 16, 1) 
		END
	END
END

GO
CREATE TRIGGER INSERT_TRAGOP
ON TRAGOP
AFTER INSERT
AS
BEGIN 
	IF (SELECT COUNT(MATG)
		FROM INSERTED
		JOIN CANHO ON CANHO.MACH = INSERTED.MACH
		JOIN HINHTHUCTG ON HINHTHUCTG.MAHT = INSERTED.MAHT
		WHERE CANHO.DIENTICH > 50
		AND HINHTHUCTG.KYHAN < 24) > 0
	BEGIN
		ROLLBACK TRANSACTION
		RAISERROR(N'Các căn hộ có diện tích trên 50m2 thì KHÔNG được trả góp với kỳ hạn dưới 24 tháng.', 16, 1) 
	END
END

GO
CREATE TRIGGER UPDATE_TRAGOP
ON TRAGOP
AFTER UPDATE
AS
BEGIN
	IF UPDATE(MACH) OR UPDATE(MAHT)
	BEGIN
		IF (SELECT COUNT(MATG)
			FROM INSERTED
			JOIN CANHO ON CANHO.MACH = INSERTED.MACH
			JOIN HINHTHUCTG ON HINHTHUCTG.MAHT = INSERTED.MAHT
			WHERE CANHO.DIENTICH > 50
			AND HINHTHUCTG.KYHAN < 24) > 0
		BEGIN
			ROLLBACK TRANSACTION
			RAISERROR(N'Các căn hộ có diện tích trên 50m2 thì KHÔNG được trả góp với kỳ hạn dưới 24 tháng.', 16, 1) 
		END
	END
END

-- 1.2
GO
CREATE TRIGGER UPDATE_CANHO
ON CANHO
AFTER UPDATE
AS
BEGIN
	IF UPDATE(SOPHONG)
	BEGIN
		IF (SELECT COUNT(MATG)
			FROM TRAGOP 
			JOIN HINHTHUCTG ON TRAGOP.MAHT = HINHTHUCTG.MAHT
			JOIN INSERTED ON INSERTED.MACH = TRAGOP.MACH
			WHERE INSERTED.SOPHONG <= 3 
			AND HINHTHUCTG.KYHAN > 36) > 0
		BEGIN
			ROLLBACK TRANSACTION
			RAISERROR(N'Các căn hộ có số phòng từ 3 trở xuống thì KHÔNG được trả góp với kỳ hạn trên 36 tháng.', 16, 1) 
		END
	END
END

GO
CREATE TRIGGER UPDATE_HINHTHUCTG
ON HINHTHUCTG
AFTER UPDATE
AS
BEGIN
	IF UPDATE(KYHAN)
	BEGIN
		IF (SELECT COUNT(MATG)
			FROM TRAGOP 
			JOIN CANHO ON TRAGOP.MACH = CANHO.MACH
			JOIN INSERTED ON INSERTED.MAHT = TRAGOP.MAHT
			WHERE CANHO.SOPHONG <= 3 
			AND INSERTED.KYHAN > 36) > 0
		BEGIN
			ROLLBACK TRANSACTION
			RAISERROR(N'Các căn hộ có số phòng từ 3 trở xuống thì KHÔNG được trả góp với kỳ hạn trên 36 tháng.', 16, 1) 
		END
	END
END

GO
CREATE TRIGGER INSERT_TRAGOP
ON TRAGOP
AFTER INSERT
AS
BEGIN 
	IF (SELECT COUNT(MATG)
		FROM INSERTED
		JOIN CANHO ON CANHO.MACH = INSERTED.MACH
		JOIN HINHTHUCTG ON HINHTHUCTG.MAHT = INSERTED.MAHT
		WHERE CANHO.SOPHONG <= 3
		AND HINHTHUCTG.KYHAN > 36) > 0
	BEGIN
		ROLLBACK TRANSACTION
		RAISERROR(N'Các căn hộ có số phòng từ 3 trở xuống thì KHÔNG được trả góp với kỳ hạn trên 36 tháng.', 16, 1) 
	END
END

GO
CREATE TRIGGER UPDATE_TRAGOP
ON TRAGOP
AFTER UPDATE
AS
BEGIN
	IF UPDATE(MACH) OR UPDATE(MAHT)
	BEGIN
		IF (SELECT COUNT(MATG)
			FROM INSERTED
			JOIN CANHO ON CANHO.MACH = INSERTED.MACH
			JOIN HINHTHUCTG ON HINHTHUCTG.MAHT = INSERTED.MAHT
			WHERE CANHO.SOPHONG <= 3
			AND HINHTHUCTG.KYHAN > 36) > 0
		BEGIN
			ROLLBACK TRANSACTION
			RAISERROR(N'Các căn hộ có số phòng từ 3 trở xuống thì KHÔNG được trả góp với kỳ hạn trên 36 tháng.', 16, 1) 
		END
	END
END

-- 1.a
SELECT KH.MAKH, KH.TENKH, KH.DIACHI
FROM KHACHHANG KH
JOIN TRAGOP TG ON KH.MAKH = TG.MAKH
WHERE YEAR(KH.NGAYSINH) BETWEEN 1980 AND 1985
AND TG.NGAYMUA = '2023-02-01'

-- 1.b
SELECT KH.TENKH, KH.DIACHI
FROM KHACHHANG KH
JOIN TRAGOP TG ON KH.MAKH = TG.MAKH
JOIN CANHO CH ON TG.MACH = CH.MACH
WHERE CH.DIENTICH > 80
ORDER BY KH.TENKH DESC

-- 1.c
SELECT LCH.MALCH, LCH.TENLCH, COUNT(CH.MACH) AS SOLUONGCANHO
FROM LOAICH LCH
JOIN CANHO CH ON  CH.MALCH = LCH.MALCH
GROUP BY LCH.MALCH, LCH.TENLCH

-- 1.d
SELECT KH.MAKH, KH.TENKH
FROM KHACHHANG KH
JOIN TRAGOP TG ON KH.MAKH = TG.MAKH
JOIN CANHO CH ON CH.MACH = TG.MACH
JOIN LOAICH LCH ON LCH.MALCH = CH.MALCH
WHERE LCH.NHOMCC = N'cao cấp'
EXCEPT
SELECT KH.MAKH, KH.TENKH
FROM KHACHHANG KH
JOIN TRAGOP TG ON KH.MAKH = TG.MAKH
JOIN CANHO CH ON CH.MACH = TG.MACH
JOIN LOAICH LCH ON LCH.MALCH = CH.MALCH
WHERE LCH.NHOMCC = N'trung cấp'

-- 1.e
SELECT KH.TENKH
FROM KHACHHANG KH
JOIN TRAGOP TG ON KH.MAKH = TG.MAKH
JOIN CANHO CH ON CH.MACH = TG.MACH
JOIN LOAICH LCH ON LCH.MALCH = CH.MALCH
WHERE LCH.NHOMCC = 'cao cấp' 
AND LCH.TENLCH = 'penhouse'
GROUP BY KH.TENKH
HAVING COUNT(DISTINCT CH.MACH) = (SELECT COUNT(MACH) 
	FROM LOAICH 
	JOIN CANHO ON CANHO.MACH = LOAICH.MALCH
	WHERE NHOMCC = 'cao cấp' 
	AND TENLCH = 'penhouse')

-- 1.f
WITH LCHCAOCAPTRAGOP AS (
	SELECT LCH.MALCH, LCH.TENLCH
	FROM LOAICH LCH
	JOIN CANHO CH ON CH.MALCH = LCH.MALCH
	JOIN TRAGOP TG ON TG.MACH = CH.MACH
	WHERE LCH.NHOMCC = 'cao cấp'
	AND YEAR(TG.NGAYMUA) = 2022
	GROUP BY LCH.MALCH, LCH.TENLCH
	HAVING COUNT(TG.MATG) > 10)
SELECT LCH.MALCH, LCH.TENLCH
FROM LOAICH LCH
WHERE LCH.MALCH IN (SELECT MALCH
	FROM LCHCAOCAPTRAGOP)

-- 2.a
SELECT CH.MACH, CH.TENCH 
FROM CANHO CH
JOIN LOAICH LCH ON LCH.MALCH = CH.MALCH
WHERE LCH.TENLCH = 'shophouse'
AND CH.GIA BETWEEN 1500000 AND 2000000

-- 2.b
SELECT CH.TENCH, CH.MALCH
FROM CANHO CH
JOIN TRAGOP TG ON CH.MACH = TG.MACH
JOIN HINHTHUCTG HT ON HT.MAHT = TG.MAHT
WHERE HT.KYHAN > 120
ORDER BY KYHAN DESC

-- 2.c
SELECT HT.MAHT, HT.TENHT, COUNT(TG.MACH) AS SOLUONGCANHO
FROM HINHTHUCTG HT
JOIN TRAGOP TG ON TG.MAHT = HT.MAHT
GROUP BY HT.MAHT, HT.TENHT

-- 2.d
SELECT KH.MAKH, KH.TENKH
FROM KHACHHANG KH
JOIN TRAGOP TG ON KH.MAKH = TG.MAKH
JOIN CANHO CH ON CH.MACH = TG.MACH
JOIN LOAICH LCH ON LCH.MALCH = CH.MALCH
WHERE LCH.TENLCH = N'penthouse'
INTERSECT
SELECT KH.MAKH, KH.TENKH
FROM KHACHHANG KH
JOIN TRAGOP TG ON KH.MAKH = TG.MAKH
JOIN CANHO CH ON CH.MACH = TG.MACH
JOIN LOAICH LCH ON LCH.MALCH = CH.MALCH
WHERE LCH.TENLCH = N'duplex'

-- 2.e
SELECT KH.TENKH
FROM KHACHHANG KH
JOIN TRAGOP TG ON KH.MAKH = TG.MAKH
JOIN CANHO CH ON CH.MACH = TG.MACH
JOIN LOAICH LCH ON LCH.MALCH = CH.MALCH
WHERE LCH.NHOMCC = 'cao cấp' 
AND LCH.TENLCH = 'duplex'
GROUP BY KH.TENKH
HAVING COUNT(DISTINCT CH.MACH) = (SELECT COUNT(MACH) 
	FROM LOAICH 
	JOIN CANHO ON CANHO.MACH = LOAICH.MALCH
	WHERE NHOMCC = 'cao cấp' 
	AND TENLCH = 'duplex')

-- 2.f
WITH KHACHHANGTRAGOP AS (
	SELECT KH.MAKH, KH.TENKH
	FROM KHACHHANG KH
	JOIN TRAGOP TG ON TG.MAKH = KH.MAKH
	JOIN CANHO CH ON CH.MACH = TG.MACH
	WHERE YEAR(TG.NGAYMUA) = 2019
	AND CH.SOPHONG = 4
	GROUP BY KH.MAKH, KH.TENKH
	HAVING SUM(TG.SOTIENTT) > 900000000)
SELECT KH.MAKH, KH.TENKH
FROM KHACHHANG KH
WHERE KH.MAKH IN (SELECT MAKH
	FROM KHACHHANGTRAGOP)