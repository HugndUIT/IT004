-- 24520602 -- Nguyễn Duy Hưng

CREATE DATABASE QuanLyTienDien

USE QuanLyTienDien

CREATE TABLE CTYDIENLUC (
    MACTY VARCHAR(10) PRIMARY KEY,
    TENCTY NVARCHAR(50) NOT NULL,
    DIABAN NVARCHAR(100),
    LOAICTY NVARCHAR(30) CHECK (LOAICTY IN (N'thành viên', N'trực thuộc'))
);

CREATE TABLE KHACHHANG (
    MAKH VARCHAR(10) PRIMARY KEY,
    TENKH NVARCHAR(50) NOT NULL,
    DIACHILH NVARCHAR(150),
    LOAIKH NVARCHAR(50) CHECK (LOAIKH IN (N'cá nhân', N'doanh nghiệp', N'cơ quan – sự nghiệp', N'bệnh viện'))
);

CREATE TABLE LOAICTD (
    MALOAICT VARCHAR(10) PRIMARY KEY,
    TENLOAICT NVARCHAR(50) NOT NULL,
    DIENAP VARCHAR(20),
    TANSO INT
);

CREATE TABLE CONGTODIEN (
    MACTD VARCHAR(15) PRIMARY KEY,
    MAKH VARCHAR(10) NOT NULL,
    NGAYLD DATE,
    DIACHILD NVARCHAR(150),
    MALOAICT VARCHAR(10),
    MACTY VARCHAR(10),
    FOREIGN KEY (MAKH) REFERENCES KHACHHANG(MAKH),
    FOREIGN KEY (MALOAICT) REFERENCES LOAICTD(MALOAICT),
    FOREIGN KEY (MACTY) REFERENCES CTYDIENLUC(MACTY)
);

CREATE TABLE GHICSD (
    MAGCSD VARCHAR(15) PRIMARY KEY,
    MACTD VARCHAR(15) NOT NULL,
    NGAYGCSD DATE,
    CSDDAUKY INT,
    CSDCUOIKY INT,
    FOREIGN KEY (MACTD) REFERENCES CONGTODIEN(MACTD)
);

CREATE TABLE HOADONDIEN (
    MAHD VARCHAR(15) PRIMARY KEY,
    MAGCSD VARCHAR(15) NOT NULL,
    CSDTIEUTHU INT, 
    NGAYTT DATE,
    SOTIENTT DECIMAL(18, 2), 
    FOREIGN KEY (MAGCSD) REFERENCES GHICSD(MAGCSD)
);

INSERT INTO CTYDIENLUC (MACTY, TENCTY, DIABAN, LOAICTY) VALUES
('DLDQ', N'Điện Lực Đa Kao', N'Quận 1', N'thành viên'),
('DLTB', N'Điện Lực Tân Bình', N'Quận Tân Bình', N'thành viên'),
('DLBT', N'Điện Lực Bình Thạnh', N'Quận Bình Thạnh', N'thành viên'),
('EVNHCM', N'Tổng Công ty ĐL TPHCM', N'Toàn TP', N'trực thuộc'),
('DLTC', N'Điện Lực Thủ Đức', N'TP Thủ Đức', N'thành viên');

INSERT INTO KHACHHANG (MAKH, TENKH, DIACHILH, LOAIKH) VALUES
('KH001', N'Nguyễn Văn A', N'123 Hai Bà Trưng, Q.1', N'cá nhân'),
('KH002', N'Công ty TNHH B', N'456 CMT8, Q.Tân Bình', N'doanh nghiệp'),
('KH003', N'Bệnh viện C', N'789 Phan Đăng Lưu, Q.Phú Nhuận', N'bệnh viện'),
('KH004', N'Sở Giáo Dục', N'10 Lãnh Binh Thăng, Q.11', N'cơ quan – sự nghiệp'),
('KH005', N'Trần Thị D', N'25 Lê Văn Việt, TP Thủ Đức', N'cá nhân');

INSERT INTO LOAICTD (MALOAICT, TENLOAICT, DIENAP, TANSO) VALUES
('LCT01', N'1 Pha 2 Dây', '220V', 50),
('LCT02', N'3 Pha Trực Tiếp', '380V', 50),
('LCT03', N'3 Pha Gián Tiếp', '6000V/380V', 50),
('LCT04', N'1 Pha Điện Tử', '220V', 50),
('LCT05', N'3 Pha Điện Tử', '380V', 50);

INSERT INTO CONGTODIEN (MACTD, MAKH, NGAYLD, DIACHILD, MALOAICT, MACTY) VALUES
('CTD001', 'KH001', '2020-01-15', N'123 Hai Bà Trưng, Q.1', 'LCT01', 'DLDQ'),
('CTD002', 'KH002', '2018-05-20', N'456 CMT8, Q.Tân Bình', 'LCT02', 'DLTB'),
('CTD003', 'KH003', '2019-11-01', N'789 Phan Đăng Lưu, Q.Phú Nhuận', 'LCT03', 'DLBT'),
('CTD004', 'KH004', '2021-03-10', N'10 Lãnh Binh Thăng, Q.11', 'LCT02', 'EVNHCM'),
('CTD005', 'KH005', '2022-07-28', N'25 Lê Văn Việt, TP Thủ Đức', 'LCT04', 'DLTC');

INSERT INTO GHICSD (MAGCSD, MACTD, NGAYGCSD, CSDDAUKY, CSDCUOIKY) VALUES
('GCS001', 'CTD001', '2025-10-25', 10000, 10150),
('GCS002', 'CTD001', '2025-11-25', 10150, 10320), 
('GCS003', 'CTD002', '2025-11-05', 50000, 51500),
('GCS004', 'CTD003', '2025-11-10', 80000, 85000),
('GCS005', 'CTD005', '2025-11-20', 500, 750);

INSERT INTO HOADONDIEN (MAHD, MAGCSD, CSDTIEUTHU, NGAYTT, SOTIENTT) VALUES
('HD001', 'GCS001', 150, '2025-11-15', 350000.00),
('HD002', 'GCS002', 170, '2025-12-15', 400000.00),
('HD003', 'GCS003', 1500, '2025-11-25', 3500000.00),
('HD004', 'GCS004', 5000, '2025-12-01', 12000000.00),
('HD005', 'GCS005', 250, '2025-12-10', 550000.00);

-- 1.1
GO
CREATE TRIGGER INSERT_HOADONDIEN
ON HOADONDIEN
AFTER INSERT
AS
BEGIN
    IF EXISTS (SELECT I.MAHD 
        FROM INSERTED I 
        JOIN GHICSD GCSD ON I.MAGCSD = GCSD.MAGCSD
        WHERE I.CSDTIEUTHU != GCSD.CSDCUOIKY - GCSD.CSDDAUKY)
    BEGIN
        ROLLBACK TRANSACTION 
        RAISERROR (N'Chỉ số điện tiêu thụ của hóa đơn điện thanh toán cho một mã ghi chỉ số điện được tính bằng hiệu của chỉ số điện cuối kỳ và chỉ số điện đầu kỳ của mã ghi chỉ số điện đo', 16, 1)
    END
END

GO
CREATE TRIGGER UPDATE_HOADONDIEN
ON HOADONDIEN
AFTER UPDATE
AS
BEGIN
    IF UPDATE(CSDTIEUTHU) OR UPDATE(MAGCSD)
    BEGIN
        IF EXISTS (SELECT I.MAHD
            FROM INSERTED I
            JOIN GHICSD GCSD ON I.MAGCSD = GCSD.MAGCSD
            WHERE I.CSDTIEUTHU != GCSD.CSDCUOIKY - GCSD.CSDDAUKY)
        BEGIN
            ROLLBACK TRANSACTION 
            RAISERROR (N'Chỉ số điện tiêu thụ của hóa đơn điện thanh toán cho một mã ghi chỉ số điện được tính bằng hiệu của chỉ số điện cuối kỳ và chỉ số điện đầu kỳ của mã ghi chỉ số điện đo', 16, 1)
        END
    END
END

GO
CREATE TRIGGER UPDATE_GHICSD
ON GHICSD
AFTER UPDATE
AS
BEGIN
    IF UPDATE(CSDDAUKY) OR UPDATE(CSDCUOIKY)
    BEGIN
        IF EXISTS (SELECT I.MAGCSD
            FROM INSERTED I
            JOIN HOADONDIEN HDD ON I.MAGCSD = HDD.MAGCSD
            WHERE HDD.CSDTIEUTHU != I.CSDCUOIKY - I.CSDDAUKY)
        BEGIN
            ROLLBACK TRANSACTION 
            RAISERROR (N'Chỉ số điện tiêu thụ của hóa đơn điện thanh toán cho một mã ghi chỉ số điện được tính bằng hiệu của chỉ số điện cuối kỳ và chỉ số điện đầu kỳ của mã ghi chỉ số điện đo', 16, 1)
        END
    END
END

-- 1.a
SELECT HDD.MAHD, HDD.MAGCSD, HDD.NGAYTT
FROM HOADONDIEN HDD
WHERE MONTH(HDD.NGAYTT) = 6
AND YEAR(HDD.NGAYTT) = 2023
AND HDD.CSDTIEUTHU BETWEEN 800 AND 1000

-- 1.b
SELECT KH.MAKH, KH.TENKH, KH.DIACHILH
FROM KHACHHANG KH
JOIN CONGTODIEN CTD ON KH.MAKH = CTD.MAKH
JOIN LOAICTD LCTD ON CTD.MALOAICT = LCTD.MALOAICT
WHERE KH.LOAIKH = N'Cá nhân' 
AND LCTD.TENLOAICT = N'1 pha điện tử 10(40)A'

-- 1.c
SELECT CTD.MACTD, SUM(HDD.CSDTIEUTHU) AS TONGSODIEN
FROM CONGTODIEN CTD
JOIN GHICSD GCSD ON CTD.MACTD = GCSD.MACTD
JOIN HOADONDIEN HDD ON HDD.MAGCSD = GCSD.MAGCSD
WHERE YEAR(GCSD.NGAYGCSD) = 2023
GROUP BY CTD.MACTD
ORDER BY TONGSODIEN ASC

-- 1.d
SELECT KH.MAKH, KH.TENKH, KH.DIACHILH
FROM KHACHHANG KH
JOIN CONGTODIEN CTD ON KH.MAKH = CTD.MAKH
JOIN LOAICTD LCTD ON CTD.MALOAICT = LCTD.MALOAICT
WHERE LCTD.TENLOAICT = N'1 pha cơ 10(20)A'
AND YEAR(CTD.NGAYLD) = 2023
INTERSECT
SELECT KH.MAKH, KH.TENKH, KH.DIACHILH
FROM KHACHHANG KH
JOIN CONGTODIEN CTD ON KH.MAKH = CTD.MAKH
JOIN LOAICTD LCTD ON CTD.MALOAICT = LCTD.MALOAICT
WHERE LCTD.TENLOAICT = N'1 pha điện tử 20(40)A'
AND YEAR(CTD.NGAYLD) = 2023

-- 1.e
SELECT CTY.MACTY, CTY.TENCTY
FROM CTYDIENLUC CTY
JOIN CONGTODIEN CTD ON CTY.MACTY = CTD.MACTY
JOIN LOAICTD LCTD ON CTD.MALOAICT = LCTD.MALOAICT
WHERE CTY.LOAICTY = N'Thành viên'
GROUP BY CTY.MACTY, CTY.TENCTY
HAVING COUNT(CTD.MACTD) = (SELECT COUNT(*)
    FROM LOAICTD LCTD0 
    WHERE LCTD0.TANSO = 50 
    AND LCTD0.DIENAP = '220')

-- 1.f
WITH SUBQUERY AS (
    SELECT CTD.MALOAICT, COUNT(CTD.MALOAICT) AS SLCTD
    FROM CONGTODIEN CTD
    JOIN CTYDIENLUC CTY ON CTY.MACTY = CTD.MACTY
    WHERE CTY.TENCTY = 'Công ty Điện lực Phú Thọ'
    AND YEAR(CTD.NGAYLD) = 2023
    GROUP BY CTD.MALOAICT)
SELECT LCTD.MALOAICT, LCTD.TENLOAICT, SQ.SLCTD
FROM LOAICTD LCTD
JOIN SUBQUERY SQ ON LCTD.MALOAICT = SQ.MALOAICT
WHERE SQ.SLCTD > 100

-- 2.a
SELECT KH.MAKH, KH.TENKH, KH.DIACHILH
FROM KHACHHANG KH
WHERE (KH.LOAIKH = N'Cơ quan-sự nghiệp' 
OR KH.LOAIKH = N'bệnh viện')
AND KH.TENKH LIKE N'%Trường%'

-- 2.b
SELECT CTD.MACTD, CTD.NGAYLD, CTD.DIACHILD
FROM CONGTODIEN CTD
JOIN LOAICTD LCTD ON CTD.MALOAICT = LCTD.MALOAICT
JOIN CTYDIENLUC CTY ON CTD.MACTY = CTY.MACTY
WHERE LCTD.TENLOAICT = N'3 pha trực tiếp 20(40)A'
AND CTY.TENCTY = N'Công ty Điện lực Gia Định'

-- 2.c
SELECT CTD.MACTD, SUM(HDD.SOTIENTT) AS TONGSOTIEN
FROM CONGTODIEN CTD
JOIN GHICSD CSD ON CTD.MACTD = CSD.MACTD
JOIN HOADONDIEN HDD ON HDD.MAGCSD = CSD.MAGCSD
WHERE YEAR(CSD.NGAYGCSD) = 2023
GROUP BY CTD.MACTD
ORDER BY TONGSOTIEN ASC

-- 2.d
SELECT DISTINCT CTD.MACTD, CTD.MAKH, CTD.DIACHILD
FROM CONGTODIEN CTD
JOIN GHICSD CSD ON CTD.MACTD = CSD.MACTD
WHERE MONTH(CSD.NGAYGCSD) = 6
AND YEAR(CSD.NGAYGCSD) = 2023
EXCEPT
SELECT DISTINCT CTD.MACTD, CTD.MAKH, CTD.DIACHILD
FROM CONGTODIEN CTD
JOIN GHICSD CSD ON CTD.MACTD = CSD.MACTD
JOIN HOADONDIEN HDD ON HDD.MAGCSD = CSD.MAGCSD
WHERE MONTH(CSD.NGAYGCSD) = 6
AND YEAR(CSD.NGAYGCSD) = 2023

-- 2.e
SELECT LCTD.MALOAICT, LCTD.TENLOAICT
FROM LOAICTD LCTD
JOIN CONGTODIEN CTD ON CTD.MALOAICT = LCTD.MALOAICT
JOIN KHACHHANG KH ON CTD.MAKH = KH.MAKH
WHERE LCTD.DIENAP = '220' 
AND LCTD.TANSO = 50
AND KH.LOAIKH = 'Cá nhân'
GROUP BY LCTD.MALOAICT, LCTD.TENLOAICT
HAVING COUNT(LCTD.MALOAICT) = (SELECT COUNT(KH0.MAKH) 
    FROM KHACHHANG KH0
    WHERE KH0.LOAIKH = 'Cá nhân')

-- 2.f
WITH SUBQUERY AS (
    SELECT CTD.MACTY, COUNT(CTD.MALOAICT) AS SLCTD
    FROM CONGTODIEN CTD
    JOIN LOAICTD LCTD ON CTD.MALOAICT = LCTD.MALOAICT
    WHERE LCTD.TENLOAICT = '3 pha gián tiếp 10(20)A'
    AND YEAR(CTD.NGAYLD) = 2023
    GROUP BY CTD.MACTY)
SELECT CT.MACTY, CT.TENCTY, SQ.SLCTD
FROM CTYDIENLUC CT
JOIN SUBQUERY SQ ON CT.MACTY = SQ.MACTY
WHERE SQ.SLCTD > 100