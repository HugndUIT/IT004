-- 24520602 -- Nguyễn Duy Hưng

CREATE DATABASE QlyKiemDinh;

USE QlyKiemDinh;

CREATE TABLE PHANXUONG (
    MaPX CHAR(5) PRIMARY KEY,
    TenPX NVARCHAR(50),
    DiaChi NVARCHAR(100),
    QuanDoc CHAR(5), 
    SLCN INT CHECK (SLCN >= 0),
    NgayTL DATE
);

CREATE TABLE CONGNHAN (
    MaCN CHAR(5) PRIMARY KEY,
    HoTen NVARCHAR(50),
    NgaySinh DATE,
    BacTho INT CHECK (BacTho BETWEEN 1 AND 7),
    MaPX CHAR(5),
    FOREIGN KEY (MaPX) REFERENCES PHANXUONG(MaPX)
);

CREATE TABLE LOAISP (
    MaLSP CHAR(5) PRIMARY KEY,
    TenLSP NVARCHAR(50),
    TinhNangNoiBat NVARCHAR(100),
    TrangThai NVARCHAR(30) CHECK (TrangThai IN (N'Đang sản xuất', N'Còn hàng', N'Ngừng sản xuất'))
);

CREATE TABLE TIEUCHUANKD (
    MaTC CHAR(5) PRIMARY KEY,
    TenTC NVARCHAR(50),
    MaLSP CHAR(5),
    MoTa NVARCHAR(100),
    DVDL NVARCHAR(20),
    KQMongDoi FLOAT,
    SaiSo FLOAT,
    FOREIGN KEY (MaLSP) REFERENCES LOAISP(MaLSP)
);

CREATE TABLE SANPHAM (
    MaSP CHAR(5) PRIMARY KEY,
    TenSP NVARCHAR(50),
    NgaySX DATE,
    MaLSP CHAR(5),
    MaPX CHAR(5),
    TinhTrangSP NVARCHAR(30) CHECK (TinhTrangSP IN (N'Chưa kiểm định', N'Đã kiểm định')),
    FOREIGN KEY (MaLSP) REFERENCES LOAISP(MaLSP),
    FOREIGN KEY (MaPX) REFERENCES PHANXUONG(MaPX)
);

CREATE TABLE KIEMDINHSP (
    MaKD CHAR(5) PRIMARY KEY,
    MaSP CHAR(5),
    MaCN CHAR(5),
    ThoiDiemKD DATETIME,
    KQKiemDinh BIT,
    NoiDung NVARCHAR(200),
    FOREIGN KEY (MaSP) REFERENCES SANPHAM(MaSP),
    FOREIGN KEY (MaCN) REFERENCES CONGNHAN(MaCN)
);

CREATE TABLE KETQUACT (
    MaKD CHAR(5),
    MaTC CHAR(5),
    KQThucTe FLOAT,
    DanhGia NVARCHAR(20) CHECK (DanhGia IN (N'Rất tốt', N'Tốt', N'Trung bình', N'Kém')),
    PRIMARY KEY (MaKD, MaTC),
    FOREIGN KEY (MaKD) REFERENCES KIEMDINHSP(MaKD),
    FOREIGN KEY (MaTC) REFERENCES TIEUCHUANKD(MaTC)
);

INSERT INTO PHANXUONG VALUES
('PX01', N'Phân xưởng A', N'Hà Nội', NULL, 20, '2015-03-01'),
('PX02', N'Phân xưởng B', N'Hải Phòng', NULL, 25, '2016-06-12'),
('PX03', N'Phân xưởng C', N'Đà Nẵng', NULL, 15, '2017-02-18'),
('PX04', N'Phân xưởng D', N'Cần Thơ', NULL, 30, '2018-09-25'),
('PX05', N'Phân xưởng E', N'TP.HCM', NULL, 18, '2019-12-10');

INSERT INTO CONGNHAN VALUES
('CN01', N'Nguyễn Văn A', '1990-02-15', 5, 'PX01'),
('CN02', N'Lê Thị B', '1995-07-21', 3, 'PX01'),
('CN03', N'Trần Văn C', '1989-10-10', 7, 'PX02'),
('CN04', N'Phạm Thị D', '1992-03-08', 4, 'PX03'),
('CN05', N'Hoàng Văn E', '1998-11-30', 2, 'PX04');

UPDATE PHANXUONG SET QuanDoc = 'CN01' WHERE MaPX = 'PX01';
UPDATE PHANXUONG SET QuanDoc = 'CN03' WHERE MaPX = 'PX02';
UPDATE PHANXUONG SET QuanDoc = 'CN04' WHERE MaPX = 'PX03';
UPDATE PHANXUONG SET QuanDoc = 'CN05' WHERE MaPX = 'PX04';
UPDATE PHANXUONG SET QuanDoc = 'CN02' WHERE MaPX = 'PX05';

INSERT INTO LOAISP VALUES
('LSP01', N'Điện thoại', N'Cấu hình mạnh, pin tốt', N'Đang sản xuất'),
('LSP02', N'Ti vi', N'Hình ảnh 4K', N'Còn hàng'),
('LSP03', N'Tủ lạnh', N'Tiết kiệm điện', N'Đang sản xuất'),
('LSP04', N'Máy giặt', N'Tự động sấy khô', N'Ngừng sản xuất'),
('LSP05', N'Laptop', N'Mỏng nhẹ, hiệu năng cao', N'Còn hàng');

INSERT INTO TIEUCHUANKD VALUES
('TC01', N'Độ bền', 'LSP01', N'Test va đập', N'kg', 100, 5),
('TC02', N'Độ sáng màn hình', 'LSP01', N'Kiểm tra độ sáng', N'nit', 400, 20),
('TC03', N'Công suất tiêu thụ', 'LSP03', N'Đo điện năng', N'W', 200, 10),
('TC04', N'Tốc độ xử lý', 'LSP05', N'Benchmark CPU', N'GHz', 3.2, 0.1),
('TC05', N'Hiệu suất làm lạnh', 'LSP03', N'Test nhiệt độ', N'°C', 5, 0.3);

INSERT INTO SANPHAM VALUES
('SP01', N'iPhone X', '2024-01-10', 'LSP01', 'PX01', N'Đã kiểm định'),
('SP02', N'Samsung S23', '2024-02-15', 'LSP01', 'PX02', N'Chưa kiểm định'),
('SP03', N'Tủ lạnh LG', '2024-03-20', 'LSP03', 'PX03', N'Đã kiểm định'),
('SP04', N'Máy giặt Panasonic', '2024-04-25', 'LSP04', 'PX04', N'Chưa kiểm định'),
('SP05', N'Laptop Dell', '2024-05-30', 'LSP05', 'PX05', N'Đã kiểm định');

INSERT INTO KIEMDINHSP VALUES
('KD01', 'SP01', 'CN01', '2024-02-01 09:00', 1, N'Đạt yêu cầu'),
('KD02', 'SP03', 'CN04', '2024-03-25 14:00', 1, N'Hoạt động ổn định'),
('KD03', 'SP05', 'CN05', '2024-06-10 10:00', 0, N'Nhiệt độ CPU cao'),
('KD04', 'SP02', 'CN03', '2024-07-05 13:30', 0, N'Màn hình bị lỗi cảm ứng'),
('KD05', 'SP04', 'CN02', '2024-08-15 15:00', 1, N'Kiểm định lại đạt');

INSERT INTO KETQUACT VALUES
('KD01', 'TC01', 102, N'Tốt'),
('KD01', 'TC02', 410, N'Rất tốt'),
('KD02', 'TC03', 198, N'Tốt'),
('KD03', 'TC04', 3.5, N'Trung bình'),
('KD05', 'TC05', 5.2, N'Rất tốt');

-- Đề I

-- 1.a
ALTER TABLE CONGNHAN ADD CONSTRAINT Check_GT CHECK(BacTho BETWEEN 1 AND 7);

-- 1.b
UPDATE SANPHAM SET TinhTrangSP = N'Chưa kiểm định' WHERE MaPX = 'PX05' AND NgaySX = '2024-10-20';

-- 2.a
SELECT MaTC, TenTC, MoTa FROM TIEUCHUANKD WHERE MaLSP = 'LSP001' AND KQMongDoi > 1000;

-- 2.b
SELECT MaSP, TenSP FROM SANPHAM JOIN PHANXUONG ON SANPHAM.MaPX = PHANXUONG.MaPX WHERE TenSP = N'Bóng Đèn LED 10W' AND TenPX = N'Phân xưởng Thiết bi';

-- 2.c
SELECT CONGNHAN.MaCN, HoTen, TenSP FROM CONGNHAN LEFT JOIN (SANPHAM JOIN KIEMDINHSP ON SANPHAM.MaSP = KIEMDINHSP.MaSP AND NgaySX = '2024-10-22') ON CONGNHAN.MaCN = KIEMDINHSP.MaCN;

-- 2.d
(SELECT KIEMDINHSP.MaKD FROM KIEMDINHSP JOIN KETQUACT ON KIEMDINHSP.MaKD = KETQUACT.MaKD JOIN TIEUCHUANKD ON TIEUCHUANKD.MaTC = KETQUACT.MaTC WHERE KQKiemDinh = 1)
EXCEPT
(SELECT KIEMDINHSP.MaKD FROM KIEMDINHSP JOIN KETQUACT ON KIEMDINHSP.MaKD = KETQUACT.MaKD JOIN TIEUCHUANKD ON TIEUCHUANKD.MaTC = KETQUACT.MaTC WHERE KQKiemDinh = 1 AND (KQThucTe < KQMongDoi));

-- 2.e
SELECT MaKD 
FROM KETQUACT
JOIN TIEUCHUANKD ON KETQUACT.MaTC = TIEUCHUANKD.MaTC
JOIN LOAISP ON TIEUCHUANKD.MaLSP = LOAISP.MaLSP
WHERE TenLSP = N'Máy Rửa Chén PX2' 
GROUP BY MaKD
HAVING COUNT(*) = SUM(CASE WHEN DanhGia = N'Tốt' THEN 1 ELSE 0 END);
 
-- 2.f
SELECT LOAISP.MaLSP, TenLSP, COUNT(DISTINCT MaSP) AS SoLuongSP
FROM LOAISP
JOIN SANPHAM ON LOAISP.MaLSP = SANPHAM.MaLSP
WHERE 
EXISTS (
    SELECT 1 FROM KIEMDINHSP WHERE KIEMDINHSP.MaSP = SANPHAM.MaSP AND KQKiemDinh = 1
)
AND EXISTS (
    SELECT 1 FROM KIEMDINHSP WHERE KIEMDINHSP.MaSP = SANPHAM.MaSP AND NoiDung IS NOT NULL
)
GROUP BY LOAISP.MaLSP, TenLSP

-- Đề II

-- 1.a
ALTER TABLE LOAISP ADD CONSTRAINT Check_MGT CHECK(TrangThai IN(N'Đang sản xuất', N'Còn hàng', N'Ngừng sản xuất'));

-- 1.b
UPDATE TIEUCHUANKD SET KQMongDoi = KQMongDoi * 1.15 WHERE MaLSP = 'LSP003' AND DVDL = N'mm';

-- 2.a
SELECT MaSP, ThoiDiemKD, NoiDung FROM KIEMDINHSP WHERE MaCN = 'CN001' AND KQKiemDinh = 0;

-- 2.b
SELECT HoTen, NoiDung FROM KIEMDINHSP JOIN CONGNHAN ON KIEMDINHSP.MaCN = CONGNHAN.MaCN JOIN SANPHAM ON KIEMDINHSP.MaSP = SANPHAM.MaSP WHERE KQKiemDinh = 0 AND TenSP = N'Tủ Lạnh 100L-C399'; 

-- 2.c
SELECT MaSP, TenSP, TenTC FROM SANPHAM LEFT JOIN TIEUCHUANKD ON SANPHAM.MaLSP = TIEUCHUANKD.MaLSP AND SaiSo > 200;

-- 2.d
SELECT KQ.MaKD
FROM KETQUACT KQ
JOIN TIEUCHUANKD TC ON KQ.MaTC = TC.MaTC
WHERE TC.TenTC IN (N'Mức tiêu thụ điện', N'Độ sáng') AND KQ.DanhGia = N'Tốt'
GROUP BY KQ.MaKD
HAVING COUNT(DISTINCT TC.TenTC) = 2;

-- 2.e
SELECT KQ.MaKD
FROM KETQUACT KQ
JOIN TIEUCHUANKD TC ON KQ.MaTC = TC.MaTC
JOIN KIEMDINHSP KD ON KQ.MaKD = KD.MaKD
WHERE TC.MaLSP = 'LSP001' AND YEAR(KD.ThoiDiemKD) = 2024
GROUP BY KQ.MaKD
HAVING COUNT(DISTINCT KQ.MaTC) = (SELECT COUNT(DISTINCT MaTC) FROM TIEUCHUANKD WHERE MaLSP = 'LSP001');

-- 2.f
SELECT PHANXUONG.MaPX, TenPX, COUNT(DISTINCT MaSP) AS SoLuongSP
FROM PHANXUONG
JOIN SANPHAM ON PHANXUONG.MaPX = SANPHAM.MaPX
WHERE 
EXISTS (
    SELECT 1 FROM KIEMDINHSP WHERE KIEMDINHSP.MaSP = SANPHAM.MaSP AND KQKiemDinh = 1
)
AND EXISTS (
    SELECT 1 FROM KIEMDINHSP WHERE KIEMDINHSP.MaSP = SANPHAM.MaSP AND NoiDung IS NOT NULL
)
GROUP BY PHANXUONG.MaPX, TenPX